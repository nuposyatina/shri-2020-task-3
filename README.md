# Задание 3. Найдите ошибки
Работу над заданием я решила разбить на 3 этапа:
  - [Исправить ошибки линтера](#%d0%98%d1%81%d0%bf%d1%80%d0%b0%d0%b2%d0%b8%d1%82%d1%8c-%d0%be%d1%88%d0%b8%d0%b1%d0%ba%d0%b8-%d0%bb%d0%b8%d0%bd%d1%82%d0%b5%d1%80%d0%b0)
  - [Восстановить работоспособность расширения](#%d0%92%d0%be%d1%81%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%b8%d1%82%d1%8c-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d0%be%d1%81%d0%bf%d0%be%d1%81%d0%be%d0%b1%d0%bd%d0%be%d1%81%d1%82%d1%8c-%d1%80%d0%b0%d1%81%d1%88%d0%b8%d1%80%d0%b5%d0%bd%d0%b8%d1%8f)
  - Исправить стилистические ошибки

## Исправить ошибки линтера
Линтер выдавал всего 2 ошибки в файле `server.ts`:
![Ошибки линтера](./img/LinterErrors.pngimg/LinterErrors.png)
1. Поле `textDocumentSync` не может быть типа `string`.

Поле `textDocumentSync` отвечает за режим синхронизации (полной или инкрементальной) между VS Code и языковым сервером. Поле может быть следующих типов: `TextDocumentSyncOptions | TextDocumentSyncKind`. Я поставила значение `docs.syncKind`, означающее режим полной синхронизации.

2. Свойство `loc` не существует в типе `AstIdentifier`.

Проблема решилась добавлением поля `loc: AstLocation;` в интерфейс `AstIdentifier` (файл `json-to-ast.d.ts`).

## Восстановить работоспособность расширения
- Превью интерфейса доступно для всех файлов `.json`.

Превью доступно, за это отвечает поле `activationEvents` в `package.json`.
- Превью открывается в отдельной вкладке при нажатии кнопки сверху от редактора

Превью открывается, но вместо отрисовки блоков в виде прямоугольников, отображается текст `{{content}}`. Cтрока {{content}} — это текущее содержимое тега body, которое должно замениться на верстку блоков.

Работа расширения начинается с функции `activate`. Она запускается, когда срабатывают события из массива `activationEvents` в `package.json` (в нашем случае это вызов команды `showPreviewToSide` или наличие файла с расширением `json`). В этой функции регистрируется команда `previewCommand`, которая как раз и ответственна за открытие превью файла. При регистрации команды передается идентификатор команды и колбэк.

В колбэке вызывается функция `openPreview`, в которой определяется, существует ли уже вкладка с превью или нужно проинициализировать новую. Здесь также запускается функция `updateContent`, в которой определяется, что именно нужно отрисовать в превью.

В функции updateContent мной как раз и была обнаружена ошибка, не позволяющая отрисовать контент. Регулярным выражением /{{\s+(\w+)\s+}}/g ищется текст типа {{ content }}, с лишними пробелами внутри. Если их убрать, можно будет увидеть превью.

Помимо этого в превью не отрисовываются стили, заданные для блоков. Все из-за того, что в html-файле задан относительный путь, а нужно передать в href путь до директории с расширением. Поэтому заменим адрес `./preview/style.css` на `{{mediaPath}}/preview/style.css`.

После этого в консоли инструментов разработчика возникла ошибка `Failed to load resource: net::ERR_UNKNOWN_URL_SCHEME`. Решением проблемы стала замена в функции getMediaPath URI-схемы. Помимо этого я убрала лишний символ `/` в конце.

До:
```
const getMediaPath = (context: vscode.ExtensionContext) => vscode.Uri
    .file(context.extensionPath)
    .with({ scheme: "resource"})
    .toString() + '/';
```
После:
```
const getMediaPath = (context: vscode.ExtensionContext) => vscode.Uri
    .file(context.extensionPath)
    .with({ scheme: "vscode-resource"})
    .toString();
```

В самом файле со стилями заменила `.div` на `div` и превью отрисовалось корректно.

- Сейчас превью отображает структуру блоков в виде прямоугольников. Реализуйте отображение превью с помощью вёрстки и JS из первого задания.

Для решения этой задачи перенесла в папку preview верстку и js из первого задания, а в файле `index.html` подключила скрипт. Верстка отображается корректно, темы переключаются.

- Линтер подсвечивает ошибочное место в файле и отображает сообщение при наведении мыши.

Не происходило создание языкового сервера и запуск клиента, не работал вывод в консоль на сервере. Заменила код
```
new SettingMonitor(client, 'example.enable').start()
```
на
```
client.start()
```
и проблема решилась. Вывод в консоль с помощью `conn.console.log('text')` теперь работает. Причину пока понять не могу.

При запуске расширения во вкладке вывод появилась ошибка `UnhandledPromiseRejectionWarning: SyntaxError: Unexpected symbol <f> at 1:1
1 | file:///Users/anya/Documents/%D0%9D%D0%BE%D0%B2%D0%B0%D1%8F%20%D0%BF%D0%B0%D0%BF%D0%BA%D0%B0/index.json`

Ее причина в том, что в функции validateTextDocument файла server.js вместо текстового содержимого файла в функции используется его URI. Чтобы это исправить, заменила код
```
const json = textDocument.uri;
```
на
```
const json = textDocument.getText();
```

Клиент запущен, но ошибки не подсвечиваются. Происходит это потому, что массив errors в ходе выполнения функции walk (файл linter.ts) не мутируется. Метод concat в колбэках, передаваемых в walk, создает новый массив, а не изменяет текущий. Заменила метод concat на push и теперь ошибки подсвечиваются.